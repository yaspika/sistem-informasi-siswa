<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Informasi Siswa - MTs Yaspika Karangtawang</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & Babel -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Icons: Lucide -->
    <script src="https://unpkg.com/lucide-react@0.378.0/dist/lucide-react.js"></script>
    
    <!-- PDF Generation: jsPDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>

    <!-- Firebase -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Expose to global scope for React components
        window.firebase = {
            initializeApp,
            getAuth,
            signInAnonymously,
            onAuthStateChanged,
            signInWithCustomToken,
            getFirestore,
            setLogLevel
        };
    </script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5;
        }
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 50;
        }
        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 0.5rem;
            max-width: 90%;
            width: 500px;
            max-height: 90vh;
            overflow-y: auto;
        }
        .sidebar-item.active {
            background-color: rgba(255, 255, 255, 0.2);
            color: white;
            font-weight: 600;
        }
        .text-3d {
             text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.2);
        }
        .title-3d {
             text-shadow: 1px 1px 3px rgba(0,0,0,0.5);
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        // Import Firebase functions from global scope
        const { initializeApp } = window.firebase;
        const { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } = window.firebase;
        const { getFirestore, collection, doc, addDoc, getDocs, onSnapshot, deleteDoc, updateDoc, query, where, writeBatch, setLogLevel } = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js");
        
        const { useState, useEffect, useMemo, useCallback, useRef } = React;

        // --- Firebase Configuration ---
        // This pattern handles both the Canvas environment (using __firebase_config) and external hosting (using the hardcoded config).
        const firebaseConfig = typeof __firebase_config !== 'undefined' 
            ? JSON.parse(__firebase_config) 
            : {
                apiKey: "AIzaSyC9U1oHDeF0wrwYVLLyJo3L6rmKBCbOQtA",
                authDomain: "sistem-siswa-yaspika.firebaseapp.com",
                projectId: "sistem-siswa-yaspika",
                storageBucket: "sistem-siswa-yaspika.appspot.com",
                messagingSenderId: "78708415258",
                appId: "1:78708415258:web:27c5f21fbcd0fd451d2aa3"
              };

        const appId = typeof __app_id !== 'undefined' ? __app_id : firebaseConfig.projectId;

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        setLogLevel('debug');

        // --- Helper Components ---
        const Icon = ({ name, ...props }) => {
            if (typeof window.lucide === 'undefined' || !window.lucide[name]) {
                return <span style={{ width: props.size || 24, height: props.size || 24, display: 'inline-block' }}></span>;
            }
            const LucideIcon = window.lucide[name];
            return React.createElement(LucideIcon, props);
        };
        
        const Modal = ({ isOpen, onClose, title, children }) => {
            if (!isOpen) return null;

            return (
                <div className="modal-backdrop" onClick={onClose}>
                    <div className="modal-content" onClick={e => e.stopPropagation()}>
                        <div className="flex justify-between items-center mb-4">
                            <h2 className="text-xl font-bold text-gray-800">{title}</h2>
                            <button onClick={onClose} className="text-gray-500 hover:text-gray-800">
                                <Icon name="X" size={24} />
                            </button>
                        </div>
                        {children}
                    </div>
                </div>
            );
        };

        // --- Main App Components ---

        // 1. Data Siswa Component
        const DataSiswa = ({ db, userId }) => {
            const [students, setStudents] = useState([]);
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [isImportModalOpen, setIsImportModalOpen] = useState(false);
            const [currentStudent, setCurrentStudent] = useState(null);
            const [searchTerm, setSearchTerm] = useState('');
            const [importData, setImportData] = useState('');
            const [isLoading, setIsLoading] = useState(true);

            const studentsCollectionPath = `artifacts/${appId}/users/${userId}/students`;

            useEffect(() => {
                if (!userId) return;
                setIsLoading(true);
                const q = query(collection(db, studentsCollectionPath));
                const unsubscribe = onSnapshot(q, (querySnapshot) => {
                    const studentsData = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    setStudents(studentsData);
                    setIsLoading(false);
                }, (error) => {
                    console.error("Error fetching students: ", error);
                    setIsLoading(false);
                });
                return () => unsubscribe();
            }, [db, userId]);

            const handleOpenModal = (student = null) => {
                setCurrentStudent(student);
                setIsModalOpen(true);
            };

            const handleCloseModal = () => {
                setIsModalOpen(false);
                setCurrentStudent(null);
            };

            const handleSaveStudent = async (studentData) => {
                try {
                    if (currentStudent) {
                        const studentDocRef = doc(db, studentsCollectionPath, currentStudent.id);
                        await updateDoc(studentDocRef, studentData);
                    } else {
                        await addDoc(collection(db, studentsCollectionPath), studentData);
                    }
                    handleCloseModal();
                } catch (error) {
                    console.error("Error saving student: ", error);
                }
            };

            const handleDeleteStudent = async (id) => {
                const confirmation = await new Promise(resolve => {
                    const confirmModal = document.createElement('div');
                    confirmModal.innerHTML = `
                        <div class="modal-backdrop">
                            <div class="modal-content">
                                <h2 class="text-xl font-bold text-gray-800 mb-4">Konfirmasi Hapus</h2>
                                <p>Apakah Anda yakin ingin menghapus data siswa ini?</p>
                                <div class="flex justify-end gap-2 mt-6">
                                    <button id="cancel-delete" class="px-4 py-2 bg-gray-200 rounded-md hover:bg-gray-300">Batal</button>
                                    <button id="confirm-delete" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700">Hapus</button>
                                </div>
                            </div>
                        </div>
                    `;
                    document.body.appendChild(confirmModal);
                    confirmModal.querySelector('#confirm-delete').onclick = () => {
                        document.body.removeChild(confirmModal);
                        resolve(true);
                    };
                    confirmModal.querySelector('#cancel-delete').onclick = () => {
                        document.body.removeChild(confirmModal);
                        resolve(false);
                    };
                });

                if (confirmation) {
                    try {
                        await deleteDoc(doc(db, studentsCollectionPath, id));
                    } catch (error) {
                        console.error("Error deleting student: ", error);
                    }
                }
            };
            
            const handleImportData = async () => {
                if (!importData.trim()) {
                    console.log("Kolom impor tidak boleh kosong.");
                    return;
                }
                const rows = importData.trim().split('\n');
                const newStudents = rows.map(row => {
                    const [nama, kelas, noHp, alamat] = row.split('\t');
                    return { nama, kelas, noHp, alamat };
                }).filter(s => s.nama && s.kelas);

                if (newStudents.length === 0) {
                    console.log("Format data tidak sesuai. Gunakan format: Nama[TAB]Kelas[TAB]No HP[TAB]Alamat");
                    return;
                }

                try {
                    const batch = writeBatch(db);
                    newStudents.forEach(student => {
                        const newDocRef = doc(collection(db, studentsCollectionPath));
                        batch.set(newDocRef, student);
                    });
                    await batch.commit();
                    console.log(`${newStudents.length} data siswa berhasil diimpor.`);
                    setImportData('');
                    setIsImportModalOpen(false);
                } catch (error) {
                    console.error("Error importing students: ", error);
                }
            };

            const exportToPDF = () => {
                const doc = new window.jspdf.jsPDF();
                doc.text("Data Siswa - MTs Yaspika Karangtawang", 14, 16);
                doc.autoTable({
                    head: [['ID', 'Nama', 'Kelas', 'No HP', 'Alamat']],
                    body: filteredStudents.map(s => [s.id.substring(0, 5), s.nama, s.kelas, s.noHp, s.alamat]),
                    startY: 20,
                });
                doc.save('data-siswa.pdf');
            };

            const filteredStudents = students.filter(student => 
                student.nama?.toLowerCase().includes(searchTerm.toLowerCase()) ||
                student.kelas?.toLowerCase().includes(searchTerm.toLowerCase())
            );

            return (
                <div className="p-6 bg-white rounded-lg shadow-md">
                    <div className="flex flex-wrap justify-between items-center mb-4 gap-3">
                        <h2 className="text-xl font-bold text-gray-800">Data Siswa</h2>
                        <div className="flex flex-wrap items-center justify-end gap-2">
                            <button onClick={() => handleOpenModal()} className="flex items-center justify-center gap-2 bg-blue-600 text-white px-3 py-1.5 rounded-md hover:bg-blue-700 transition-colors duration-200 text-sm">
                                <Icon name="Plus" size={16}/>
                                <span>Tambah Siswa</span>
                            </button>
                            <button onClick={() => setIsImportModalOpen(true)} className="flex items-center justify-center gap-2 bg-green-600 text-white px-3 py-1.5 rounded-md hover:bg-green-700 transition-colors duration-200 text-sm" title="Import dari Excel">
                                <Icon name="Upload" size={16}/>
                                <span>Import</span>
                            </button>
                            <button onClick={exportToPDF} className="flex items-center justify-center gap-2 bg-red-600 text-white px-3 py-1.5 rounded-md hover:bg-red-700 transition-colors duration-200 text-sm" title="Export ke PDF">
                                <Icon name="FileDown" size={16}/>
                                <span>Export</span>
                            </button>
                        </div>
                    </div>

                    <div className="mb-4">
                        <div className="relative w-full md:w-1/2 lg:w-1/3">
                            <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <Icon name="Search" className="text-gray-400" size={20} />
                            </div>
                            <input
                                type="text"
                                placeholder="Cari nama atau kelas..."
                                className="w-full p-2 pl-10 border rounded-md bg-gray-50 focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                value={searchTerm}
                                onChange={(e) => setSearchTerm(e.target.value)}
                            />
                        </div>
                    </div>
                    
                    {isLoading ? <p>Memuat data...</p> : (
                    <div className="overflow-x-auto">
                        <table className="w-full text-left border-collapse text-sm">
                            <thead className="bg-gray-100">
                                <tr>
                                    <th className="p-2 font-semibold text-gray-600">Nama</th>
                                    <th className="p-2 font-semibold text-gray-600">Kelas</th>
                                    <th className="p-2 font-semibold text-gray-600">No HP</th>
                                    <th className="p-2 font-semibold text-gray-600">Alamat</th>
                                    <th className="p-2 font-semibold text-gray-600 text-right">Aksi</th>
                                </tr>
                            </thead>
                            <tbody>
                                {filteredStudents.map(student => (
                                    <tr key={student.id} className="border-b hover:bg-gray-50">
                                        <td className="p-2">{student.nama}</td>
                                        <td className="p-2">{student.kelas}</td>
                                        <td className="p-2">{student.noHp}</td>
                                        <td className="p-2">{student.alamat}</td>
                                        <td className="p-2 flex gap-2 justify-end">
                                            <button onClick={() => handleOpenModal(student)} className="p-1 rounded bg-yellow-400 text-white hover:bg-yellow-500 transition-colors"><Icon name="Edit" size={18}/></button>
                                            <button onClick={() => handleDeleteStudent(student.id)} className="p-1 rounded bg-red-500 text-white hover:bg-red-600 transition-colors"><Icon name="Trash2" size={18}/></button>
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                    )}
                    {filteredStudents.length === 0 && !isLoading && <p className="text-center mt-4 text-gray-500">Tidak ada data siswa.</p>}

                    <Modal isOpen={isModalOpen} onClose={handleCloseModal} title={currentStudent ? "Edit Data Siswa" : "Tambah Data Siswa"}>
                        <StudentForm student={currentStudent} onSave={handleSaveStudent} onClose={handleCloseModal} />
                    </Modal>

                    <Modal isOpen={isImportModalOpen} onClose={() => setIsImportModalOpen(false)} title="Import Data dari Excel">
                        <div>
                            <p className="mb-2 text-sm text-gray-600">Salin kolom dari Excel (Nama, Kelas, No HP, Alamat) tanpa header, lalu tempel di bawah ini.</p>
                            <p className="mb-4 text-xs text-gray-500">Pastikan urutan kolom benar dan dipisahkan oleh Tab (default saat copy dari Excel).</p>
                            <textarea
                                className="w-full h-40 p-2 border rounded-md"
                                placeholder="Contoh:&#10;Budi Santoso\t7A\t081234567890\tJl. Merdeka No. 1&#10;Siti Aminah\t7A\t081234567891\tJl. Pahlawan No. 2"
                                value={importData}
                                onChange={(e) => setImportData(e.target.value)}
                            ></textarea>
                            <div className="flex justify-end gap-2 mt-4">
                                <button onClick={() => setIsImportModalOpen(false)} className="px-4 py-2 bg-gray-200 rounded-md hover:bg-gray-300">Batal</button>
                                <button onClick={handleImportData} className="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Import</button>
                            </div>
                        </div>
                    </Modal>
                </div>
            );
        };

        const StudentForm = ({ student, onSave, onClose }) => {
            const [formData, setFormData] = useState({
                nama: '',
                kelas: '',
                noHp: '',
                alamat: ''
            });

            useEffect(() => {
                if (student) {
                    setFormData(student);
                } else {
                    setFormData({ nama: '', kelas: '', noHp: '', alamat: '' });
                }
            }, [student]);

            const handleChange = (e) => {
                const { name, value } = e.target;
                setFormData(prev => ({ ...prev, [name]: value }));
            };

            const handleSubmit = (e) => {
                e.preventDefault();
                onSave(formData);
            };

            const kelasOptions = ['7A', '7B', '7C', '8A', '8B', '8C', '9A', '9B', '9C'];

            return (
                <form onSubmit={handleSubmit}>
                    <div className="space-y-4">
                        <input type="text" name="nama" value={formData.nama} onChange={handleChange} placeholder="Nama Lengkap" className="w-full p-2 border rounded-md" required />
                        <select name="kelas" value={formData.kelas} onChange={handleChange} className="w-full p-2 border rounded-md" required>
                            <option value="">Pilih Kelas</option>
                            {kelasOptions.map(k => <option key={k} value={k}>{k}</option>)}
                        </select>
                        <input type="tel" name="noHp" value={formData.noHp} onChange={handleChange} placeholder="No HP" className="w-full p-2 border rounded-md" />
                        <textarea name="alamat" value={formData.alamat} onChange={handleChange} placeholder="Alamat" className="w-full p-2 border rounded-md"></textarea>
                    </div>
                    <div className="flex justify-end gap-2 mt-6">
                        <button type="button" onClick={onClose} className="px-4 py-2 bg-gray-200 rounded-md hover:bg-gray-300">Batal</button>
                        <button type="submit" className="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Simpan</button>
                    </div>
                </form>
            );
        };

        // 2. Kehadiran Component
        const Kehadiran = ({ db, userId }) => {
            const [absences, setAbsences] = useState([]);
            const [students, setStudents] = useState([]);
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [isLoading, setIsLoading] = useState(true);
            const [currentAbsence, setCurrentAbsence] = useState(null);

            const studentsCollectionPath = `artifacts/${appId}/users/${userId}/students`;
            const absencesCollectionPath = `artifacts/${appId}/users/${userId}/absences`;

            useEffect(() => {
                if (!userId) return;
                const q = query(collection(db, studentsCollectionPath));
                const unsubscribe = onSnapshot(q, (querySnapshot) => {
                    setStudents(querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                });
                return () => unsubscribe();
            }, [db, userId]);

            useEffect(() => {
                if (!userId) return;
                setIsLoading(true);
                const q = query(collection(db, absencesCollectionPath));
                const unsubscribe = onSnapshot(q, (querySnapshot) => {
                    setAbsences(querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                    setIsLoading(false);
                });
                return () => unsubscribe();
            }, [db, userId]);

            const handleOpenModal = (absence = null) => {
                setCurrentAbsence(absence);
                setIsModalOpen(true);
            };

            const handleSaveAbsence = async (absenceData) => {
                try {
                    const student = students.find(s => s.id === absenceData.studentId);
                    if (!student) {
                        console.error("Siswa tidak ditemukan");
                        return;
                    }

                    const dataToSave = {
                        ...absenceData,
                        studentName: student.nama,
                        kelas: student.kelas
                    };

                    if (currentAbsence) {
                        await updateDoc(doc(db, absencesCollectionPath, currentAbsence.id), dataToSave);
                    } else {
                        await addDoc(collection(db, absencesCollectionPath), dataToSave);
                    }
                    setIsModalOpen(false);
                    setCurrentAbsence(null);
                } catch (error) {
                    console.error("Error saving absence: ", error);
                }
            };
            
            const handleDeleteAbsence = async (id) => {
                const confirmation = await new Promise(resolve => {
                    const confirmModal = document.createElement('div');
                    confirmModal.innerHTML = `
                        <div class="modal-backdrop">
                            <div class="modal-content">
                                <h2 class="text-xl font-bold text-gray-800 mb-4">Konfirmasi Hapus</h2>
                                <p>Apakah Anda yakin ingin menghapus data kehadiran ini?</p>
                                <div class="flex justify-end gap-2 mt-6">
                                    <button id="cancel-delete" class="px-4 py-2 bg-gray-200 rounded-md hover:bg-gray-300">Batal</button>
                                    <button id="confirm-delete" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700">Hapus</button>
                                </div>
                            </div>
                        </div>
                    `;
                    document.body.appendChild(confirmModal);
                    confirmModal.querySelector('#confirm-delete').onclick = () => {
                        document.body.removeChild(confirmModal);
                        resolve(true);
                    };
                    confirmModal.querySelector('#cancel-delete').onclick = () => {
                        document.body.removeChild(confirmModal);
                        resolve(false);
                    };
                });

                if (confirmation) {
                    try {
                        await deleteDoc(doc(db, absencesCollectionPath, id));
                    } catch (error) {
                        console.error("Error deleting absence: ", error);
                    }
                }
            };

            const exportToPDF = () => {
                const doc = new window.jspdf.jsPDF();
                doc.text("Data Ketidakhadiran Siswa - MTs Yaspika Karangtawang", 14, 16);
                doc.autoTable({
                    head: [['Tanggal', 'Nama', 'Kelas', 'Keterangan']],
                    body: absences.map(a => [a.tanggal, a.studentName, a.kelas, a.keterangan]),
                    startY: 20,
                });
                doc.save('data-ketidakhadiran.pdf');
            };

            return (
                <div className="p-6 bg-white rounded-lg shadow-md">
                    <div className="flex flex-wrap justify-between items-center mb-4 gap-2">
                        <h2 className="text-xl font-bold text-gray-800">Kehadiran</h2>
                        <div className="flex gap-2">
                            <button onClick={() => handleOpenModal()} className="flex items-center justify-center gap-2 bg-blue-600 text-white px-3 py-1.5 rounded-md hover:bg-blue-700 transition-colors duration-200 text-sm">
                                <Icon name="Plus" size={16}/>
                                <span className="hidden sm:inline">Catat Ketidakhadiran</span>
                                <span className="sm:hidden">Catat</span>
                            </button>
                            <button onClick={exportToPDF} className="flex items-center justify-center gap-2 bg-red-600 text-white px-3 py-1.5 rounded-md hover:bg-red-700 transition-colors duration-200 text-sm">
                                <Icon name="FileDown" size={16}/>
                                <span className="hidden sm:inline">Export ke PDF</span>
                                <span className="sm:hidden">Export</span>
                            </button>
                        </div>
                    </div>
                    {isLoading ? <p>Memuat data...</p> : (
                    <div className="overflow-x-auto">
                        <table className="w-full text-left border-collapse text-sm">
                            <thead className="bg-gray-100">
                                <tr>
                                    <th className="p-2 font-semibold text-gray-600">Tanggal</th>
                                    <th className="p-2 font-semibold text-gray-600">Nama</th>
                                    <th className="p-2 font-semibold text-gray-600">Kelas</th>
                                    <th className="p-2 font-semibold text-gray-600">Keterangan</th>
                                    <th className="p-2 font-semibold text-gray-600 text-right">Aksi</th>
                                </tr>
                            </thead>
                            <tbody>
                                {absences.map(absence => (
                                    <tr key={absence.id} className="border-b hover:bg-gray-50">
                                        <td className="p-2">{absence.tanggal}</td>
                                        <td className="p-2">{absence.studentName}</td>
                                        <td className="p-2">{absence.kelas}</td>
                                        <td className="p-2">{absence.keterangan}</td>
                                        <td className="p-2 flex gap-2 justify-end">
                                            <button onClick={() => handleOpenModal(absence)} className="p-1 rounded bg-yellow-400 text-white hover:bg-yellow-500 transition-colors"><Icon name="Edit" size={18}/></button>
                                            <button onClick={() => handleDeleteAbsence(absence.id)} className="p-1 rounded bg-red-500 text-white hover:bg-red-600 transition-colors"><Icon name="Trash2" size={18}/></button>
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                    )}
                    {absences.length === 0 && !isLoading && <p className="text-center mt-4 text-gray-500">Tidak ada data ketidakhadiran.</p>}
                    <Modal isOpen={isModalOpen} onClose={() => { setIsModalOpen(false); setCurrentAbsence(null); }} title={currentAbsence ? "Edit Ketidakhadiran" : "Catat Ketidakhadiran"}>
                        <AbsenceForm students={students} onSave={handleSaveAbsence} onClose={() => { setIsModalOpen(false); setCurrentAbsence(null); }} currentAbsence={currentAbsence} />
                    </Modal>
                </div>
            );
        };
        
        const AbsenceForm = ({ students, onSave, onClose, currentAbsence }) => {
            const [formData, setFormData] = useState({
                tanggal: new Date().toISOString().split('T')[0],
                studentId: '',
                keterangan: 'Sakit'
            });

            useEffect(() => {
                if (currentAbsence) {
                    setFormData({
                        tanggal: currentAbsence.tanggal,
                        studentId: currentAbsence.studentId,
                        keterangan: currentAbsence.keterangan,
                    });
                } else {
                     setFormData({
                        tanggal: new Date().toISOString().split('T')[0],
                        studentId: '',
                        keterangan: 'Sakit'
                    });
                }
            }, [currentAbsence]);

            const handleChange = (e) => {
                const { name, value } = e.target;
                setFormData(prev => ({ ...prev, [name]: value }));
            };

            const handleSubmit = (e) => {
                e.preventDefault();
                if (!formData.studentId) {
                    console.log("Silakan pilih siswa.");
                    return;
                }
                onSave(formData);
            };

            const keteranganOptions = ['Sakit', 'Izin', 'Alpa', 'Kesiangan', 'Bolos'];

            return (
                <form onSubmit={handleSubmit}>
                    <div className="space-y-4">
                        <input type="date" name="tanggal" value={formData.tanggal} onChange={handleChange} className="w-full p-2 border rounded-md" required />
                        <select name="studentId" value={formData.studentId} onChange={handleChange} className="w-full p-2 border rounded-md" required>
                            <option value="">Pilih Siswa</option>
                            {students.map(s => <option key={s.id} value={s.id}>{s.nama} ({s.kelas})</option>)}
                        </select>
                        <select name="keterangan" value={formData.keterangan} onChange={handleChange} className="w-full p-2 border rounded-md" required>
                            {keteranganOptions.map(k => <option key={k} value={k}>{k}</option>)}
                        </select>
                    </div>
                    <div className="flex justify-end gap-2 mt-6">
                        <button type="button" onClick={onClose} className="px-4 py-2 bg-gray-200 rounded-md hover:bg-gray-300">Batal</button>
                        <button type="submit" className="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Simpan</button>
                    </div>
                </form>
            );
        };
        
        // 3. Kejadian Component
        const Kejadian = ({ db, userId }) => {
            const [incidents, setIncidents] = useState([]);
            const [students, setStudents] = useState([]);
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [isLoading, setIsLoading] = useState(true);
            const [currentIncident, setCurrentIncident] = useState(null);

            const studentsCollectionPath = `artifacts/${appId}/users/${userId}/students`;
            const incidentsCollectionPath = `artifacts/${appId}/users/${userId}/incidents`;

            useEffect(() => {
                if (!userId) return;
                const q = query(collection(db, studentsCollectionPath));
                const unsubscribe = onSnapshot(q, (querySnapshot) => {
                    setStudents(querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                });
                return () => unsubscribe();
            }, [db, userId]);
            
            useEffect(() => {
                if (!userId) return;
                setIsLoading(true);
                const q = query(collection(db, incidentsCollectionPath));
                const unsubscribe = onSnapshot(q, (querySnapshot) => {
                    setIncidents(querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                    setIsLoading(false);
                });
                return () => unsubscribe();
            }, [db, userId]);

            const handleOpenModal = (incident = null) => {
                setCurrentIncident(incident);
                setIsModalOpen(true);
            };

            const handleSaveIncident = async (incidentData) => {
                try {
                    const student = students.find(s => s.id === incidentData.studentId);
                    if (!student) {
                        console.error("Siswa tidak ditemukan");
                        return;
                    }
                    
                    const dataToSave = {
                        ...incidentData,
                        studentName: student.nama,
                        kelas: student.kelas,
                        tanggal: incidentData.tanggal || new Date().toISOString().split('T')[0]
                    };

                    if (currentIncident) {
                        await updateDoc(doc(db, incidentsCollectionPath, currentIncident.id), dataToSave);
                    } else {
                        await addDoc(collection(db, incidentsCollectionPath), dataToSave);
                    }
                    setIsModalOpen(false);
                    setCurrentIncident(null);
                } catch (error) {
                    console.error("Error saving incident: ", error);
                }
            };

            const handleDeleteIncident = async (id) => {
                 const confirmation = await new Promise(resolve => {
                    const confirmModal = document.createElement('div');
                    confirmModal.innerHTML = `
                        <div class="modal-backdrop">
                            <div class="modal-content">
                                <h2 class="text-xl font-bold text-gray-800 mb-4">Konfirmasi Hapus</h2>
                                <p>Apakah Anda yakin ingin menghapus data kejadian ini?</p>
                                <div class="flex justify-end gap-2 mt-6">
                                    <button id="cancel-delete" class="px-4 py-2 bg-gray-200 rounded-md hover:bg-gray-300">Batal</button>
                                    <button id="confirm-delete" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700">Hapus</button>
                                </div>
                            </div>
                        </div>
                    `;
                    document.body.appendChild(confirmModal);
                    confirmModal.querySelector('#confirm-delete').onclick = () => {
                        document.body.removeChild(confirmModal);
                        resolve(true);
                    };
                    confirmModal.querySelector('#cancel-delete').onclick = () => {
                        document.body.removeChild(confirmModal);
                        resolve(false);
                    };
                });

                if (confirmation) {
                    try {
                        await deleteDoc(doc(db, incidentsCollectionPath, id));
                    } catch (error) {
                        console.error("Error deleting incident: ", error);
                    }
                }
            };
            
            const exportToPDF = () => {
                const doc = new window.jspdf.jsPDF();
                doc.text("Data Kejadian Siswa - MTs Yaspika Karangtawang", 14, 16);
                doc.autoTable({
                    head: [['Tanggal', 'Nama', 'Kelas', 'Jenis Kejadian']],
                    body: incidents.map(i => [i.tanggal, i.studentName, i.kelas, i.jenisKejadian]),
                    startY: 20,
                });
                doc.save('data-kejadian.pdf');
            };

            return (
                <div className="p-6 bg-white rounded-lg shadow-md">
                    <div className="flex justify-between items-center mb-4">
                        <h2 className="text-xl font-bold text-gray-800">Kejadian</h2>
                        <div className="flex gap-2">
                           <button onClick={() => handleOpenModal()} className="flex items-center gap-2 bg-blue-600 text-white px-3 py-1.5 rounded-md hover:bg-blue-700 transition text-sm">
                                <Icon name="Plus" size={16}/> Catat Kejadian
                            </button>
                             <button onClick={exportToPDF} className="flex items-center gap-2 bg-red-600 text-white px-3 py-1.5 rounded-md hover:bg-red-700 transition text-sm">
                                <Icon name="FileDown" size={16}/> Export ke PDF
                            </button>
                        </div>
                    </div>
                    {isLoading ? <p>Memuat data...</p> : (
                    <div className="overflow-x-auto">
                        <table className="w-full text-left border-collapse text-sm">
                            <thead className="bg-gray-100">
                                <tr>
                                    <th className="p-2 font-semibold text-gray-600">Tanggal</th>
                                    <th className="p-2 font-semibold text-gray-600">Nama</th>
                                    <th className="p-2 font-semibold text-gray-600">Kelas</th>
                                    <th className="p-2 font-semibold text-gray-600">Jenis Kejadian</th>
                                    <th className="p-2 font-semibold text-gray-600 text-right">Aksi</th>
                                </tr>
                            </thead>
                            <tbody>
                                {incidents.map(incident => (
                                    <tr key={incident.id} className="border-b hover:bg-gray-50">
                                        <td className="p-2">{incident.tanggal}</td>
                                        <td className="p-2">{incident.studentName}</td>
                                        <td className="p-2">{incident.kelas}</td>
                                        <td className="p-2">{incident.jenisKejadian === 'Lainnya' ? `Lainnya: ${incident.keteranganLainnya}` : incident.jenisKejadian}</td>
                                        <td className="p-2 flex gap-2 justify-end">
                                            <button onClick={() => handleOpenModal(incident)} className="p-1 rounded bg-yellow-400 text-white hover:bg-yellow-500 transition-colors"><Icon name="Edit" size={18}/></button>
                                            <button onClick={() => handleDeleteIncident(incident.id)} className="p-1 rounded bg-red-500 text-white hover:bg-red-600 transition-colors"><Icon name="Trash2" size={18}/></button>
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                    )}
                    {incidents.length === 0 && !isLoading && <p className="text-center mt-4 text-gray-500">Tidak ada data kejadian.</p>}
                    <Modal isOpen={isModalOpen} onClose={() => { setIsModalOpen(false); setCurrentIncident(null); }} title={currentIncident ? "Edit Kejadian" : "Catat Kejadian"}>
                        <IncidentForm students={students} onSave={handleSaveIncident} onClose={() => { setIsModalOpen(false); setCurrentIncident(null); }} currentIncident={currentIncident} />
                    </Modal>
                </div>
            );
        };

        const IncidentForm = ({ students, onSave, onClose, currentIncident }) => {
            const [formData, setFormData] = useState({
                studentId: '',
                jenisKejadian: 'Berkelahi',
                keteranganLainnya: ''
            });

             useEffect(() => {
                if (currentIncident) {
                    setFormData({
                        studentId: currentIncident.studentId,
                        jenisKejadian: currentIncident.jenisKejadian,
                        keteranganLainnya: currentIncident.keteranganLainnya || ''
                    });
                } else {
                     setFormData({
                        studentId: '',
                        jenisKejadian: 'Berkelahi',
                        keteranganLainnya: ''
                    });
                }
            }, [currentIncident]);

            const handleChange = (e) => {
                const { name, value } = e.target;
                setFormData(prev => ({ ...prev, [name]: value }));
            };

            const handleSubmit = (e) => {
                e.preventDefault();
                if (!formData.studentId) {
                    console.log("Silakan pilih siswa.");
                    return;
                }
                onSave(formData);
            };

            const jenisKejadianOptions = ['Berkelahi', 'Merokok', 'Pacaran', 'Bullying', 'Tidak Sholat', 'Tidak Ikut Upacara', 'Pakaian', 'Melawan Guru', 'Lainnya'];

            return (
                <form onSubmit={handleSubmit}>
                    <div className="space-y-4">
                        <select name="studentId" value={formData.studentId} onChange={handleChange} className="w-full p-2 border rounded-md" required>
                            <option value="">Pilih Siswa</option>
                            {students.map(s => <option key={s.id} value={s.id}>{s.nama} ({s.kelas})</option>)}
                        </select>
                        <select name="jenisKejadian" value={formData.jenisKejadian} onChange={handleChange} className="w-full p-2 border rounded-md" required>
                            {jenisKejadianOptions.map(k => <option key={k} value={k}>{k}</option>)}
                        </select>
                        {formData.jenisKejadian === 'Lainnya' && (
                            <textarea name="keteranganLainnya" value={formData.keteranganLainnya} onChange={handleChange} placeholder="Keterangan lainnya" className="w-full p-2 border rounded-md"></textarea>
                        )}
                    </div>
                    <div className="flex justify-end gap-2 mt-6">
                        <button type="button" onClick={onClose} className="px-4 py-2 bg-gray-200 rounded-md hover:bg-gray-300">Batal</button>
                        <button type="submit" className="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Simpan</button>
                    </div>
                </form>
            );
        };

        // 4. Rekap Component
        const Rekap = ({ db, userId }) => {
            const [activeTab, setActiveTab] = useState('kehadiran');
            const [students, setStudents] = useState([]);
            const [absences, setAbsences] = useState([]);
            const [incidents, setIncidents] = useState([]);
            const [kelasOptions, setKelasOptions] = useState([]);
            
            const studentsCollectionPath = `artifacts/${appId}/users/${userId}/students`;
            const absencesCollectionPath = `artifacts/${appId}/users/${userId}/absences`;
            const incidentsCollectionPath = `artifacts/${appId}/users/${userId}/incidents`;

            useEffect(() => {
                if (!userId) return;
                const unsubStudents = onSnapshot(query(collection(db, studentsCollectionPath)), (snap) => {
                    const studentData = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    setStudents(studentData);
                    const uniqueKelas = [...new Set(studentData.map(s => s.kelas))].sort();
                    setKelasOptions(uniqueKelas);
                });
                const unsubAbsences = onSnapshot(query(collection(db, absencesCollectionPath)), (snap) => {
                    setAbsences(snap.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                });
                const unsubIncidents = onSnapshot(query(collection(db, incidentsCollectionPath)), (snap) => {
                    setIncidents(snap.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                });

                return () => {
                    unsubStudents();
                    unsubAbsences();
                    unsubIncidents();
                };
            }, [db, userId]);

            return (
                <div className="p-6 bg-white rounded-lg shadow-md">
                    <h2 className="text-xl font-bold mb-4 text-gray-800">Rekapitulasi</h2>
                    <div className="border-b border-gray-200">
                        <nav className="-mb-px flex space-x-8" aria-label="Tabs">
                            <button onClick={() => setActiveTab('kehadiran')} className={`${activeTab === 'kehadiran' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'} whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm`}>
                                Rekap Kehadiran
                            </button>
                            <button onClick={() => setActiveTab('kejadian')} className={`${activeTab === 'kejadian' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'} whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm`}>
                                Rekap Kejadian
                            </button>
                        </nav>
                    </div>
                    <div className="mt-6">
                        {activeTab === 'kehadiran' && <RekapKehadiran students={students} absences={absences} kelasOptions={kelasOptions} />}
                        {activeTab === 'kejadian' && <RekapKejadian students={students} incidents={incidents} kelasOptions={kelasOptions} />}
                    </div>
                </div>
            );
        };
        
        const RekapKehadiran = ({ students, absences, kelasOptions }) => {
            const [filters, setFilters] = useState({ kelas: '', startDate: '', endDate: '' });
            const [rekapData, setRekapData] = useState([]);

            const handleFilterChange = (e) => {
                setFilters(prev => ({ ...prev, [e.target.name]: e.target.value }));
            };

            const getStatusKehadiran = (total) => {
                if (total === 0) return { text: 'Sangat Baik', color: 'bg-green-100 text-green-800' };
                if (total >= 1 && total <= 3) return { text: 'Baik', color: 'bg-blue-100 text-blue-800' };
                if (total >= 4 && total <= 6) return { text: 'Sedang', color: 'bg-gray-200 text-gray-800' };
                if (total > 6 && total <= 15) return { text: 'Kurang', color: 'bg-yellow-100 text-yellow-800' };
                return { text: 'Buruk', color: 'bg-red-100 text-red-800' };
            };

            const generateRekap = () => {
                let filteredStudents = students;
                if (filters.kelas) {
                    filteredStudents = students.filter(s => s.kelas === filters.kelas);
                }

                let filteredAbsences = absences;
                if (filters.startDate && filters.endDate) {
                    filteredAbsences = absences.filter(a => a.tanggal >= filters.startDate && a.tanggal <= filters.endDate);
                }

                const data = filteredStudents.map(student => {
                    const studentAbsences = filteredAbsences.filter(a => a.studentId === student.id);
                    const counts = { Sakit: 0, Izin: 0, Alpa: 0, Kesiangan: 0, Bolos: 0 };
                    studentAbsences.forEach(a => {
                        if (counts.hasOwnProperty(a.keterangan)) {
                            counts[a.keterangan]++;
                        }
                    });
                    
                    const total = (counts.Sakit > 10 ? counts.Sakit - 10 : 0) + 
                                  (counts.Izin > 3 ? counts.Izin - 3 : 0) + 
                                  counts.Alpa + counts.Kesiangan + counts.Bolos;

                    const status = getStatusKehadiran(total);

                    return {
                        id: student.id,
                        nama: student.nama,
                        ...counts,
                        status
                    };
                });
                setRekapData(data);
            };
            
            const exportToPDF = () => {
                const doc = new window.jspdf.jsPDF('landscape');
                doc.text(`Rekap Kehadiran - Kelas: ${filters.kelas || 'Semua'}`, 14, 16);
                doc.autoTable({
                    head: [['No', 'Nama', 'Sakit', 'Izin', 'Alpa', 'Kesiangan', 'Bolos', 'Status']],
                    body: rekapData.map((d, i) => [i + 1, d.nama, d.Sakit, d.Izin, d.Alpa, d.Kesiangan, d.Bolos, d.status.text]),
                    startY: 20,
                });
                doc.save('rekap-kehadiran.pdf');
            };

            return (
                <div>
                    <div className="flex flex-wrap gap-4 items-end mb-4 p-4 bg-gray-50 rounded-lg">
                        <div className="flex-1 min-w-[150px]">
                            <label className="block text-sm font-medium text-gray-700">Kelas</label>
                            <select name="kelas" value={filters.kelas} onChange={handleFilterChange} className="w-full p-2 border rounded-md mt-1">
                                <option value="">Semua Kelas</option>
                                {kelasOptions.map(k => <option key={k} value={k}>{k}</option>)}
                            </select>
                        </div>
                        <div className="flex-1 min-w-[150px]">
                            <label className="block text-sm font-medium text-gray-700">Tanggal Mulai</label>
                            <input type="date" name="startDate" value={filters.startDate} onChange={handleFilterChange} className="w-full p-2 border rounded-md mt-1" />
                        </div>
                        <div className="flex-1 min-w-[150px]">
                            <label className="block text-sm font-medium text-gray-700">Tanggal Akhir</label>
                            <input type="date" name="endDate" value={filters.endDate} onChange={handleFilterChange} className="w-full p-2 border rounded-md mt-1" />
                        </div>
                        <button onClick={generateRekap} className="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">Lihat Data</button>
                        <button onClick={exportToPDF} disabled={rekapData.length === 0} className="bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700 disabled:bg-red-300">Export PDF</button>
                    </div>

                    <div className="overflow-x-auto">
                        <table className="w-full text-left border-collapse text-sm">
                             <thead className="bg-gray-100">
                                <tr>
                                    <th className="p-2 font-semibold text-gray-600">No</th>
                                    <th className="p-2 font-semibold text-gray-600">Nama</th>
                                    <th className="p-2 font-semibold text-gray-600">Sakit</th>
                                    <th className="p-2 font-semibold text-gray-600">Izin</th>
                                    <th className="p-2 font-semibold text-gray-600">Alpa</th>
                                    <th className="p-2 font-semibold text-gray-600">Kesiangan</th>
                                    <th className="p-2 font-semibold text-gray-600">Bolos</th>
                                    <th className="p-2 font-semibold text-gray-600">Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                {rekapData.map((d, i) => (
                                    <tr key={d.id} className="border-b hover:bg-gray-50">
                                        <td className="p-2">{i + 1}</td>
                                        <td className="p-2">{d.nama}</td>
                                        <td className="p-2">{d.Sakit}</td>
                                        <td className="p-2">{d.Izin}</td>
                                        <td className="p-2">{d.Alpa}</td>
                                        <td className="p-2">{d.Kesiangan}</td>
                                        <td className="p-2">{d.Bolos}</td>
                                        <td className="p-2"><span className={`px-2 py-1 text-xs font-medium rounded-full ${d.status.color}`}>{d.status.text}</span></td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                        {rekapData.length === 0 && <p className="text-center mt-4 text-gray-500">Klik "Lihat Data" untuk menampilkan rekap.</p>}
                    </div>
                </div>
            );
        };
        
        const RekapKejadian = ({ students, incidents, kelasOptions }) => {
            const [filters, setFilters] = useState({ kelas: '', startDate: '', endDate: '' });
            const [rekapData, setRekapData] = useState([]);

            const handleFilterChange = (e) => {
                setFilters(prev => ({ ...prev, [e.target.name]: e.target.value }));
            };
            
            const getStatusKejadian = (total) => {
                if (total === 0) return { text: 'Baik', color: 'bg-green-100 text-green-800' };
                if (total >= 1 && total <= 2) return { text: 'Sedang', color: 'bg-gray-200 text-gray-800' };
                if (total >= 3 && total <= 5) return { text: 'Kurang', color: 'bg-yellow-100 text-yellow-800' };
                return { text: 'Buruk', color: 'bg-red-100 text-red-800' };
            };

            const generateRekap = () => {
                let filteredStudents = students;
                if (filters.kelas) {
                    filteredStudents = students.filter(s => s.kelas === filters.kelas);
                }

                let filteredIncidents = incidents;
                if (filters.startDate && filters.endDate) {
                    filteredIncidents = incidents.filter(i => i.tanggal >= filters.startDate && i.tanggal <= filters.endDate);
                }

                const data = filteredStudents.map(student => {
                    const studentIncidents = filteredIncidents.filter(i => i.studentId === student.id);
                    const totalKejadian = studentIncidents.length;
                    
                    let keterangan = '-';
                    if (totalKejadian > 0) {
                        const incidentCounts = studentIncidents.reduce((acc, curr) => {
                            acc[curr.jenisKejadian] = (acc[curr.jenisKejadian] || 0) + 1;
                            return acc;
                        }, {});
                        keterangan = Object.keys(incidentCounts).reduce((a, b) => incidentCounts[a] > incidentCounts[b] ? a : b);
                    }
                    
                    const status = getStatusKejadian(totalKejadian);

                    return {
                        id: student.id,
                        nama: student.nama,
                        totalKejadian,
                        keterangan,
                        status
                    };
                });
                setRekapData(data);
            };
            
            const exportToPDF = () => {
                const doc = new window.jspdf.jsPDF();
                doc.text(`Rekap Kejadian - Kelas: ${filters.kelas || 'Semua'}`, 14, 16);
                doc.autoTable({
                    head: [['No', 'Nama', 'Total Kejadian', 'Keterangan Dominan', 'Status']],
                    body: rekapData.map((d, i) => [i + 1, d.nama, d.totalKejadian, d.keterangan, d.status.text]),
                    startY: 20,
                });
                doc.save('rekap-kejadian.pdf');
            };

            return (
                <div>
                     <div className="flex flex-wrap gap-4 items-end mb-4 p-4 bg-gray-50 rounded-lg">
                        <div className="flex-1 min-w-[150px]">
                            <label className="block text-sm font-medium text-gray-700">Kelas</label>
                            <select name="kelas" value={filters.kelas} onChange={handleFilterChange} className="w-full p-2 border rounded-md mt-1">
                                <option value="">Semua Kelas</option>
                                {kelasOptions.map(k => <option key={k} value={k}>{k}</option>)}
                            </select>
                        </div>
                        <div className="flex-1 min-w-[150px]">
                            <label className="block text-sm font-medium text-gray-700">Tanggal Mulai</label>
                            <input type="date" name="startDate" value={filters.startDate} onChange={handleFilterChange} className="w-full p-2 border rounded-md mt-1" />
                        </div>
                        <div className="flex-1 min-w-[150px]">
                            <label className="block text-sm font-medium text-gray-700">Tanggal Akhir</label>
                            <input type="date" name="endDate" value={filters.endDate} onChange={handleFilterChange} className="w-full p-2 border rounded-md mt-1" />
                        </div>
                        <button onClick={generateRekap} className="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">Lihat Data</button>
                        <button onClick={exportToPDF} disabled={rekapData.length === 0} className="bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700 disabled:bg-red-300">Export PDF</button>
                    </div>

                    <div className="overflow-x-auto">
                        <table className="w-full text-left border-collapse text-sm">
                            <thead className="bg-gray-100">
                                <tr>
                                    <th className="p-2 font-semibold text-gray-600">No</th>
                                    <th className="p-2 font-semibold text-gray-600">Nama</th>
                                    <th className="p-2 font-semibold text-gray-600">Total Kejadian</th>
                                    <th className="p-2 font-semibold text-gray-600">Keterangan Dominan</th>
                                    <th className="p-2 font-semibold text-gray-600">Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                {rekapData.map((d, i) => (
                                    <tr key={d.id} className="border-b hover:bg-gray-50">
                                        <td className="p-2">{i + 1}</td>
                                        <td className="p-2">{d.nama}</td>
                                        <td className="p-2">{d.totalKejadian}</td>
                                        <td className="p-2">{d.keterangan}</td>
                                        <td className="p-2"><span className={`px-2 py-1 text-xs font-medium rounded-full ${d.status.color}`}>{d.status.text}</span></td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                        {rekapData.length === 0 && <p className="text-center mt-4 text-gray-500">Klik "Lihat Data" untuk menampilkan rekap.</p>}
                    </div>
                </div>
            );
        };

        // --- App Container ---
        function App() {
            const [currentPage, setCurrentPage] = useState('DataSiswa');
            const [isAuthReady, setIsAuthReady] = useState(false);
            const [userId, setUserId] = useState(null);
            const [logoSrc, setLogoSrc] = useState('https://placehold.co/256x256/15803d/FFFFFF?text=LOGO');

            useEffect(() => {
                const initAuth = async () => {
                    try {
                        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                        if (initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } else {
                            await signInAnonymously(auth);
                        }
                    } catch (error) {
                        console.error("Authentication error:", error);
                        if (error.code.includes('auth/')) { // If it's an auth error, try to sign in anonymously
                             try {
                                await signInAnonymously(auth);
                            } catch (fallbackError) {
                                console.error("Fallback authentication error:", fallbackError);
                            }
                        }
                    }
                };

                const unsubscribe = onAuthStateChanged(auth, (user) => {
                    if (user) {
                        setUserId(user.uid);
                    } else {
                        setUserId(null); 
                    }
                    setIsAuthReady(true);
                });

                initAuth();
                return () => unsubscribe();
            }, []);
            
            const menuItems = [
                { id: 'DataSiswa', label: 'Data Siswa', icon: 'Users' },
                { id: 'Kehadiran', label: 'Kehadiran', icon: 'CalendarCheck' },
                { id: 'Kejadian', label: 'Kejadian', icon: 'AlertTriangle' },
                { id: 'Rekap', label: 'Rekap', icon: 'BarChart3' },
            ];

            const renderPage = () => {
                if (!isAuthReady) {
                    return <div className="p-6"><p>Inisialisasi aplikasi...</p></div>;
                }
                if (!userId) {
                    return <div className="p-6"><p>Autentikasi gagal. Mohon segarkan halaman.</p></div>;
                }
                switch (currentPage) {
                    case 'DataSiswa':
                        return <DataSiswa db={db} userId={userId} />;
                    case 'Kehadiran':
                        return <Kehadiran db={db} userId={userId} />;
                    case 'Kejadian':
                        return <Kejadian db={db} userId={userId} />;
                    case 'Rekap':
                        return <Rekap db={db} userId={userId} />;
                    default:
                        return <DataSiswa db={db} userId={userId} />;
                }
            };

            return (
                <div className="flex h-screen bg-gray-100">
                    <aside className="w-48 bg-gray-900 text-white flex flex-col flex-shrink-0">
                        <div className="p-4 flex flex-col items-center justify-center pt-6 pb-4 border-b border-white/20 relative bg-gradient-to-r from-red-600 to-green-600">
                             <label htmlFor="logo-upload" className="absolute top-2 right-2 cursor-pointer text-white/70 hover:text-white transition-colors" title="Ganti Logo">
                                 <Icon name="Settings" size={18} />
                             </label>
                             <input id="logo-upload" type="file" className="hidden" accept="image/*" onChange={(e) => {
                                 const file = e.target.files[0];
                                 if (file) {
                                     const reader = new FileReader();
                                     reader.onload = (ev) => setLogoSrc(ev.target.result);
                                     reader.readAsDataURL(file);
                                 }
                             }} />
                             
                             <img src={logoSrc} alt="Logo Sekolah" className="w-12 h-12 rounded-full mb-3 object-cover shadow-lg cursor-pointer" onClick={() => document.getElementById('logo-upload').click()} onError={(e) => { e.target.onerror = null; e.target.src='https://placehold.co/256x256/15803d/FFFFFF?text=LOGO'; }}/>
                             <div className="text-center font-bold title-3d">
                                 <span className="block text-base font-bold bg-gradient-to-r from-red-500 via-white to-white bg-clip-text text-transparent">Sistem Informasi Siswa</span>
                                 <span className="block text-xs text-yellow-300">MTs Yaspika Karangtawang</span>
                             </div>
                        </div>
                        <nav className="flex-1 p-2 space-y-1 bg-gradient-to-b from-red-700 to-blue-800">
                            {menuItems.map(item => (
                                <button
                                    key={item.id}
                                    onClick={() => setCurrentPage(item.id)}
                                    className={`sidebar-item w-full text-left flex items-center gap-3 px-3 py-3 rounded-md transition hover:bg-white/10 ${currentPage === item.id ? 'active' : ''}`}
                                >
                                    <Icon name={item.icon} size={20} />
                                    <span className="text-3d">{item.label}</span>
                                </button>
                            ))}
                        </nav>
                        <div className="p-4 text-center text-xs bg-gradient-to-r from-blue-800 to-red-800">
                            <p className="font-semibold text-white/90">Created by Herdiyana</p>
                            <p className="text-white/70">Layanan BK MTs Yaspika</p>
                        </div>
                    </aside>
                    <div className="flex-1 flex flex-col overflow-hidden">
                        <main className="flex-1 overflow-y-auto p-4 sm:p-6 lg:p-8">
                           {renderPage()}
                        </main>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>

</body>
</html>
